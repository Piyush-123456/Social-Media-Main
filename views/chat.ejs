<%- include('partials/header') %>
    <%- include('partials/nav') %>

        <div class="container">
            <div class="left">
                <div class="users">
                    <% users.forEach(singleUser=> { %>
                        <div onclick="openChat('<%= singleUser.avatar.url %>', '<%= singleUser.fullname %>')"
                            class="user">
                            <img class="user-img"
                                src="<%= singleUser.avatar.url ? singleUser.avatar.url : 'https://th.bing.com/th/id/OIP.Ps-WjXJNyJJ8R696WKbjggHaHa?w=194&h=194&c=7&r=0&o=5&dpr=1.3&pid=1.7' %>"
                                alt="">

                            <h1 class="chatname">
                                <%= singleUser.fullname %>
                            </h1>
                        </div>
                        <% }) %>
                </div>
            </div>

            <div class="right">
                <div class="top">
                    <div class="user">
                        <img class="user-img"
                            src="https://images.unsplash.com/photo-1484589065579-248aad0d8b13?w=800&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YWJzdHJhY3R8ZW58MHx8MHx8fDA%3D"
                            alt="">
                        <h1 class="chatname">username</h1>
                    </div>
                </div>
                <div class="bottom">
                    <div class="conversationArea"></div>
                    <div class="inputField">
                        <input type="text" placeholder="Enter message">
                        <button id="sendMessage" class="send-button">
                            <i class="ri-send-plane-line"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io();
            const loggedInUsername = "<%= user.fullname %>";
            let receiver = null;

            socket.emit('join', loggedInUsername);

            function openChat(userImage, fullname) {
                receiver = fullname;
                const defaultAvatarUrl = 'https://th.bing.com/th/id/OIP.Ps-WjXJNyJJ8R696WKbjggHaHa?w=194&h=194&c=7&r=0&o=5&dpr=1.3&pid=1.7';
                document.querySelector('.right .top .user-img').src = userImage ? userImage : defaultAvatarUrl;
                document.querySelector('.right .top .chatname').innerText = fullname;

                socket.emit('openChat', {
                    receiver,
                    sender: loggedInUsername
                });
            }

            socket.on("openChat", messages => {
                messages.forEach(messageObject => {
                    if (messageObject.sender === loggedInUsername) {
                        appendOutgoingMessage(messageObject.text);
                    } else {
                        appendIncomingMessage(messageObject.text);
                    }
                });
            });

            function appendOutgoingMessage(message) {
                const template = `
      <div class="message outgoing">
        <p>${message}</p>
      </div>`;
                document.querySelector('.conversationArea').innerHTML += template;
            }

            function appendIncomingMessage(message) {
                const template = `
      <div class="message incoming">
        <p>${message}</p>
      </div>`;
                document.querySelector('.conversationArea').innerHTML += template;
            }

            socket.on('max', messageObject => {
                appendIncomingMessage(messageObject.message);
            });

            document.querySelector('#sendMessage').addEventListener('click', () => {
                const message = document.querySelector('.inputField input').value;
                appendOutgoingMessage(message);

                socket.emit('sony', {
                    message,
                    receiver,
                    sender: loggedInUsername
                });
            });
        </script>

        <%- include('partials/footer') %>
            <style>
                /* Container */
                .container {
                    display: flex;
                    width: 100vw;
                    height: 100vh;
                    gap: 1rem;
                    /* background-color: #f0f4f8; */
                    /* Light background for contrast */
                }

                /* Left Section */
                .left {
                    flex: 0 0 350px;
                    /* Fixed width for sidebar */
                    background-color: #ffffff;
                    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
                    /* Light shadow for separation */
                    padding: 1rem;
                    width: 30vw;
                    /* background-color: red; */
                }

                .users {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                }

                /* User Card */
                .user {
                    display: flex;
                    gap: 0.75rem;
                    align-items: center;
                    padding: 0.75rem;
                    border-radius: 0.5rem;
                    background-color: #f9f9f9;
                    cursor: pointer;
                    transition: background-color 0.2s;
                }

                .user:hover {
                    background-color: #e0e0e0;
                    /* Slightly darker on hover */
                }

                .user-img {
                    width: 50px;
                    /* Adjust size for consistency */
                    height: 50px;
                    border-radius: 50%;
                    object-fit: cover;
                    /* Ensure image covers the circle */
                }

                .chatname {
                    font-size: 1rem;
                    font-weight: bold;
                    color: #333;
                    /* Darker text for better readability */
                }

                /* Right Section */
                .right {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    background-color: #ffffff;
                    padding: 1rem;
                    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
                    /* Light shadow for separation */
                }

                /* Top Section */
                .top {
                    display: flex;
                    align-items: center;
                    margin-bottom: 1rem;
                }

                .top .user {
                    display: flex;
                    align-items: center;
                    width: 100%;
                }

                .top .user-img {
                    width: 50px;
                    /* Consistent size */
                    height: 50px;
                    /* margin-right: 0.5rem; */
                }

                .top .user-name {
                    font-size: 1rem;
                    /* font-weight: bold;
                     */
                    font-family: gilroy;
                }

                /* Bottom Section */
                .bottom {
                    display: flex;
                    flex-direction: column;
                    height: 100%;
                }

                .conversationArea {
                    flex: 1;
                    padding: 1rem;
                    overflow-y: auto;
                    /* Scrollable if messages overflow */
                }

                .inputField {
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    padding: 0.75rem;
                    background-color: #f9f9f9;
                    border-top: 1px solid #ddd;
                    /* Divider for input area */
                }

                input {
                    flex: 1;
                    padding: 0.75rem;
                    border-radius: 0.5rem;
                    border: 1px solid #ddd;
                    outline: none;
                }

                input:focus {
                    border-color: #007bff;
                    /* Highlight on focus */
                }

                .send-button {
                    padding: 0.75rem;
                    background-color: #007bff;
                    border: none;
                    border-radius: 50%;
                    color: #fff;
                    cursor: pointer;
                    transition: background-color 0.2s;
                }

                .send-button:hover {
                    background-color: #0056b3;
                    /* Darker blue on hover */
                }

                /* Message Styles */
                .message {
                    padding: 0.75rem;
                    border-radius: 0.5rem;
                    background-color: #e9ecef;
                    margin: 0.5rem 0;
                    max-width: 70%;
                    word-wrap: break-word;
                    /* Handle long messages */
                }

                .outgoing {
                    background-color: #007bff;
                    color: #fff;
                    margin-left: auto;
                    /* Align to right for outgoing */
                }

                .incoming {
                    background-color: #e9ecef;
                    color: #333;
                }
            </style>